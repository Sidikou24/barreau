<!-- templates/batonnier/gestion_utilisateurs.html -->
{% extends "layout.html" %}

{% block title %}Gestion des Utilisateurs - Barreau du Niger{% endblock %}

{% block content %}
<div x-data="gestionUtilisateurs" class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">Gestion des Utilisateurs</h1>
            <p class="text-muted-foreground">Gérez les utilisateurs du système de gestion du Barreau</p>
        </div>
        <button class="btn btn-primary" @click="showCreateDialog = true">
            <i data-lucide="user-plus" class="h-4 w-4 mr-2"></i> Nouveau utilisateur
        </button>
    </div>

    <!-- Barre de recherche -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"></i>
                    <input type="text" placeholder="Rechercher un utilisateur..." x-model="searchTerm" class="input pl-8"/>
                </div>
            </div>
            <div class="text-sm text-muted-foreground" x-text="filteredUsers.length + ' utilisateur(s)'"></div>
        </div>
    </div>

    <!-- Liste des utilisateurs -->
    <div class="grid gap-4">
        <template x-for="user in filteredUsers" :key="user.id">
            <div class="card p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="avatar h-12 w-12 text-lg">
                            <span x-text="user.name.charAt(0)"></span>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold" x-text="user.name"></h3>
                                <span 
                                    class="badge"
                                    :class="user.active ? 'badge-green' : 'badge-red'"
                                    x-text="user.active ? 'Actif' : 'Inactif'"
                                ></span>
                            </div>
                            <p class="text-sm text-muted-foreground" x-text="user.email"></p>
                            <p class="text-xs text-muted-foreground" x-text="getRoleLabel(user.role)"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Toggle Status -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-muted-foreground">Actif</span>
                            <label class="switch">
                                <input type="checkbox" :checked="user.active" @change="toggleUserStatus(user.id)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <!-- Action Buttons -->
                        <button class="btn btn-ghost" style="padding: 0.25rem 0.5rem;" @click="openEditDialog(user)">
                            <i data-lucide="edit" class="h-4 w-4"></i>
                        </button>
                        <button 
                            class="btn btn-ghost" 
                            style="padding: 0.25rem 0.5rem;" 
                            @click="deleteUser(user.id)"
                            :disabled="user.id === currentUserId"
                            :class="{ 'opacity-50 cursor-not-allowed': user.id === currentUserId }"
                        >
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal Créer Utilisateur -->
    <div x-show="showCreateDialog" class="modal" @click.self="showCreateDialog = false">
        <div class="modal-content">
            <div class="mb-6">
                <h2 class="text-xl font-semibold">Créer un nouvel utilisateur</h2>
                <p class="text-sm text-muted-foreground">Ajoutez un nouveau compte utilisateur au système</p>
            </div>
            <form @submit.prevent="createUser" class="space-y-4">
                <div class="space-y-2">
                    <label for="name" class="text-sm font-medium">Nom complet *</label>
                    <input id="name" x-model="formData.name" placeholder="Nom complet de l'utilisateur" required class="input"/>
                </div>
                <div class="space-y-2">
                    <label for="email" class="text-sm font-medium">Email *</label>
                    <input id="email" type="email" x-model="formData.email" placeholder="adresse@email.com" required class="input"/>
                </div>
                <div class="space-y-2">
                    <label for="role" class="text-sm font-medium">Rôle *</label>
                    <select x-model="formData.role" required class="select">
                        <option value="">Sélectionner un rôle</option>
                        <option value="assistant_admin">Assistant Administratif</option>
                        <option value="secretary">Secrétaire de l'Ordre</option>
                        <option value="treasurer">Trésorière</option>
                        <option value="batonnier">Bâtonnier</option>
                        <option value="lawyer">Avocat</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="btn btn-primary flex-1">Créer l'utilisateur</button>
                    <button type="button" class="btn btn-outline" @click="showCreateDialog = false">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Modifier Utilisateur -->
    <div x-show="showEditDialog" class="modal" @click.self="showEditDialog = false">
        <div class="modal-content">
            <div class="mb-6">
                <h2 class="text-xl font-semibold">Modifier l'utilisateur</h2>
                <p class="text-sm text-muted-foreground">Modifiez les informations de l'utilisateur</p>
            </div>
            <form @submit.prevent="editUser" class="space-y-4">
                <div class="space-y-2">
                    <label for="editName" class="text-sm font-medium">Nom complet *</label>
                    <input id="editName" x-model="formData.name" placeholder="Nom complet de l'utilisateur" required class="input"/>
                </div>
                <div class="space-y-2">
                    <label for="editEmail" class="text-sm font-medium">Email *</label>
                    <input id="editEmail" type="email" x-model="formData.email" placeholder="adresse@email.com" required class="input"/>
                </div>
                <div class="space-y-2">
                    <label for="editRole" class="text-sm font-medium">Rôle *</label>
                    <select x-model="formData.role" required class="select">
                        <option value="">Sélectionner un rôle</option>
                        <option value="assistant_admin">Assistant Administratif</option>
                        <option value="secretary">Secrétaire de l'Ordre</option>
                        <option value="treasurer">Trésorière</option>
                        <option value="batonnier">Bâtonnier</option>
                        <option value="lawyer">Avocat</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="btn btn-primary flex-1">Sauvegarder</button>
                    <button type="button" class="btn btn-outline" @click="showEditDialog = false">Annuler</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('gestionUtilisateurs', () => ({
            currentUserId: '1', // ID du bâtonnier connecté
            searchTerm: '',
            showCreateDialog: false,
            showEditDialog: false,
            selectedUser: null,
            users: [
                {
                    id: '1',
                    name: 'Maître Amadou DIALLO',
                    email: 'batonnier@barreau.ne',
                    role: 'batonnier',
                    active: true
                },
                {
                    id: '2',
                    name: 'Admin Système',
                    email: 'admin@barreau.ne',
                    role: 'assistant_admin',
                    active: true
                },
                {
                    id: '3',
                    name: 'Maître Aicha IBRAHIM',
                    email: 'secretaire@barreau.ne',
                    role: 'secretary',
                    active: true
                },
                {
                    id: '4',
                    name: 'Maître Mariama HASSAN',
                    email: 'treasurer@barreau.ne',
                    role: 'treasurer',
                    active: true
                },
                {
                    id: '5',
                    name: 'Maître Ibrahim MOUSSA',
                    email: 'lawyer@barreau.ne',
                    role: 'lawyer',
                    active: false
                }
            ],
            formData: {
                name: '',
                email: '',
                role: ''
            },
            get filteredUsers() {
                if (!this.searchTerm) return this.users;
                return this.users.filter(user => 
                    user.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                    user.email.toLowerCase().includes(this.searchTerm.toLowerCase())
                );
            },
            getRoleLabel(role) {
                const roles = {
                    'assistant_admin': 'Assistant Administratif',
                    'secretary': 'Secrétaire de l\'Ordre',
                    'treasurer': 'Trésorière',
                    'batonnier': 'Bâtonnier',
                    'lawyer': 'Avocat'
                };
                return roles[role] || role;
            },
            createUser() {
                if (!this.formData.name || !this.formData.email || !this.formData.role) {
                    this.showToast("Erreur", "Veuillez remplir tous les champs obligatoires", "error");
                    return;
                }
                const newUser = {
                    id: Date.now().toString(),
                    name: this.formData.name,
                    email: this.formData.email,
                    role: this.formData.role,
                    active: true
                };
                this.users.push(newUser);
                this.showToast("Succès", "Utilisateur créé avec succès");
                this.showCreateDialog = false;
                this.formData = { name: '', email: '', role: '' };
            },
            openEditDialog(user) {
                this.selectedUser = user;
                this.formData = {
                    name: user.name,
                    email: user.email,
                    role: user.role
                };
                this.showEditDialog = true;
            },
            editUser() {
                if (!this.selectedUser || !this.formData.name || !this.formData.email || !this.formData.role) {
                    this.showToast("Erreur", "Veuillez remplir tous les champs obligatoires", "error");
                    return;
                }
                const userIndex = this.users.findIndex(u => u.id === this.selectedUser.id);
                if (userIndex !== -1) {
                    this.users[userIndex] = {
                        ...this.users[userIndex],
                        name: this.formData.name,
                        email: this.formData.email,
                        role: this.formData.role
                    };
                }
                this.showToast("Succès", "Informations mises à jour avec succès");
                this.showEditDialog = false;
                this.selectedUser = null;
                this.formData = { name: '', email: '', role: '' };
            },
            toggleUserStatus(userId) {
                const userIndex = this.users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    this.users[userIndex].active = !this.users[userIndex].active;
                    this.showToast("Succès", "Statut mis à jour avec succès");
                }
            },
            deleteUser(userId) {
                if (userId === this.currentUserId) {
                    this.showToast("Erreur", "Vous ne pouvez pas supprimer votre propre compte", "error");
                    return;
                }
                if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                    this.users = this.users.filter(u => u.id !== userId);
                    this.showToast("Succès", "Utilisateur supprimé avec succès");
                }
            },
            logout() {
                if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                    window.location.href = "{{ url_for('logout') }}";
                }
            },
            showToast(title, description, type = 'success') {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-card border border-border rounded-lg p-4 shadow-lg z-50';
                toast.innerHTML = `
                    <div class="font-medium">${title}</div>
                    <div class="text-sm text-muted-foreground">${description}</div>
                `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }))
    })
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
</script>
{% endblock %}

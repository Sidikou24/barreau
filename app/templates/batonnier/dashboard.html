{% extends "layout.html" %}
{% block title %}Gestion des Utilisateurs - Barreau du Niger{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- En-tête -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">Gestion des Utilisateurs</h1>
            <p class="text-muted-foreground">Gérez les utilisateurs du système de gestion du Barreau</p>
        </div>
        <button
            class="btn btn-primary"
            onclick="document.getElementById('createUserModal').classList.remove('hidden')"
        >
            <i data-lucide="user-plus" class="h-4 w-4 mr-2"></i> Nouveau utilisateur
        </button>
    </div>

    <!-- Barre de recherche -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"></i>
                    <input
                        type="text"
                        placeholder="Rechercher un utilisateur..."
                        id="searchInput"
                        onkeyup="filterUsers()"
                        class="input pl-8 w-full"
                    />
                </div>
            </div>
            <div class="text-sm text-muted-foreground">
                {{ users|length }} utilisateur(s)
            </div>
        </div>
    </div>

    <!-- Liste des utilisateurs -->
    <div class="grid gap-4" id="userList">
        {% for user in users %}
        <div class="card p-6 user-item" data-name="{{ user.nom }} {{ user.prenom }}" data-email="{{ user.email }}">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="avatar h-12 w-12 text-lg bg-primary text-primary-foreground flex items-center justify-center rounded-full">
                        <span>{{ user.nom[0] if user.nom else 'U' }}</span>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <h3 class="font-semibold">{{ user.nom }} {{ user.prenom }}</h3>
                            <span class="px-2 py-0.5 text-xs rounded-full {% if user.statut == 'actif' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ user.statut|capitalize }}
                            </span>
                        </div>
                        <p class="text-sm text-muted-foreground">{{ user.email }}</p>
                        <p class="text-xs text-muted-foreground">
                            {% if user.role == 'assistant_admin' %}Assistant Administratif
                            {% elif user.role == 'secretary' %}Secrétaire de l'Ordre
                            {% elif user.role == 'treasurer' %}Trésorière
                            {% elif user.role == 'batonnier' %}Bâtonnier
                            {% elif user.role == 'lawyer' %}Avocat
                            {% else %}{{ user.role|capitalize }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Toggle Status -->
                    <form action="{{ url_for('batonnier.toggle_user_status', user_id=user.id) }}" method="POST" class="flex items-center gap-2">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <span class="text-sm text-muted-foreground">Actif</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input
                                type="checkbox"
                                name="active"
                                {% if user.statut == 'actif' %}checked{% endif %}
                                onchange="this.form.submit()"
                                class="sr-only peer"
                            >
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-green-600"></div>
                        </label>
                    </form>
                    <!-- Bouton Modifier -->
                    <button
                        class="btn btn-ghost p-1.5"
                        onclick="openEditModal(
                            '{{ user.id }}',
                            '{{ user.nom }}',
                            '{{ user.prenom }}',
                            '{{ user.email }}',
                            '{{ user.role }}',
                            '{{ user.statut }}',
                            '{{ user.telephone|default('', true) }}',
                            '{{ user.adresse|default('', true) }}',
                            '{{ user.date_naissance.strftime('%Y-%m-%d') if user.date_naissance else '' }}'
                        )"
                    >
                        <i data-lucide="edit" class="h-4 w-4"></i>
                    </button>
                    <!-- Bouton Supprimer -->
                    <form action="{{ url_for('batonnier.supprimer_utilisateur', user_id=user.id) }}" method="POST" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button
                            type="submit"
                            class="btn btn-ghost p-1.5 {% if user.id == current_user.id %}opacity-50 cursor-not-allowed{% endif %}"
                            {% if user.id == current_user.id %}disabled{% endif %}
                            onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?');"
                        >
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal Créer Utilisateur -->
    <div id="createUserModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2" id="modal-title">
                                Créer un nouvel utilisateur
                            </h3>
                            <p class="text-sm text-gray-500 mb-4">
                                Ajoutez un nouveau compte utilisateur au système
                            </p>
                            <form method="POST" action="{{ url_for('batonnier.nouveau_utilisateur') }}" class="space-y-4">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="space-y-2">
                                    <label for="nom" class="block text-sm font-medium text-gray-700">Nom *</label>
                                    <input type="text" name="nom" id="nom" required class="input w-full" placeholder="Nom de famille">
                                </div>
                                <div class="space-y-2">
                                    <label for="prenom" class="block text-sm font-medium text-gray-700">Prénom *</label>
                                    <input type="text" name="prenom" id="prenom" required class="input w-full" placeholder="Prénom">
                                </div>
                                <div class="space-y-2">
                                    <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
                                    <input type="email" name="email" id="email" required class="input w-full" placeholder="adresse@email.com">
                                </div>
                                <div class="space-y-2">
                                    <label for="role" class="block text-sm font-medium text-gray-700">Rôle *</label>
                                    <select name="role" id="role" required class="select w-full">
                                        <option value="">Sélectionner un rôle</option>
                                        <option value="assistant_administratif">Assistant Administratif</option>
                                        <option value="secretaire">Secrétaire de l'Ordre</option>
                                        <option value="tresorier">Trésorière</option>
                                        <option value="batonnier">Bâtonnier</option>
                                        <option value="avocat">Avocat</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label for="date_naissance" class="block text-sm font-medium text-gray-700">Date de naissance *</label>
                                    <input type="date" name="date_naissance" id="date_naissance" required class="input w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="telephone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                                    <input type="text" name="telephone" id="telephone" class="input w-full" placeholder="Numéro de téléphone">
                                </div>
                                <div class="space-y-2">
                                    <label for="adresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                                    <input type="text" name="adresse" id="adresse" class="input w-full" placeholder="Adresse">
                                </div>
                                <div class="space-y-2" id="avocatFields" style="display: none;">
                                    <label for="qualification" class="block text-sm font-medium text-gray-700">Qualification</label>
                                    <select name="qualification" id="qualification" class="select w-full">
                                        <option value="stagiaire">Stagiaire</option>
                                        <option value="avocat">Avocat</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label for="sexe" class="block text-sm font-medium text-gray-700">Sexe</label>
                                    <select name="sexe" id="sexe" class="select w-full">
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="pt-5 sm:flex sm:flex-row-reverse">
                                    <button type="submit" class="btn btn-primary w-full sm:w-auto sm:ml-3">
                                        Créer l'utilisateur
                                    </button>
                                    <button type="button" class="btn btn-outline w-full sm:w-auto mt-3 sm:mt-0" onclick="document.getElementById('createUserModal').classList.add('hidden')">
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Modifier Utilisateur -->
    <div id="editUserModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2" id="modal-title">
                                Modifier l'utilisateur
                            </h3>
                            <p class="text-sm text-gray-500 mb-4">
                                Modifiez les informations de l'utilisateur
                            </p>
                            <form id="editUserForm" method="POST" class="space-y-4">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="user_id" id="editUserId">
                                <div class="space-y-2">
                                    <label for="editNom" class="block text-sm font-medium text-gray-700">Nom *</label>
                                    <input type="text" name="nom" id="editNom" required class="input w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="editPrenom" class="block text-sm font-medium text-gray-700">Prénom *</label>
                                    <input type="text" name="prenom" id="editPrenom" required class="input w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="editEmail" class="block text-sm font-medium text-gray-700">Email *</label>
                                    <input type="email" name="email" id="editEmail" required class="input w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="editRole" class="block text-sm font-medium text-gray-700">Rôle *</label>
                                    <select name="role" id="editRole" required class="select w-full">
                                        <option value="assistant_admin">Assistant Administratif</option>
                                        <option value="secretary">Secrétaire de l'Ordre</option>
                                        <option value="treasurer">Trésorière</option>
                                        <option value="batonnier">Bâtonnier</option>
                                        <option value="lawyer">Avocat</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label for="editDateNaissance" class="block text-sm font-medium text-gray-700">Date de naissance *</label>
                                    <input type="date" name="date_naissance" id="editDateNaissance" required class="input w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="editTelephone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                                    <input type="text" name="telephone" id="editTelephone" class="input w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="editAdresse" class="block text-sm font-medium text-gray-700">Adresse</label>
                                    <input type="text" name="adresse" id="editAdresse" class="input w-full">
                                </div>
                                <div class="space-y-2" id="editAvocatFields" style="display: none;">
                                    <label for="editQualification" class="block text-sm font-medium text-gray-700">Qualification</label>
                                    <select name="qualification" id="editQualification" class="select w-full">
                                        <option value="stagiaire">Stagiaire</option>
                                        <option value="avocat">Avocat</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label for="editSexe" class="block text-sm font-medium text-gray-700">Sexe</label>
                                    <select name="sexe" id="editSexe" class="select w-full">
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                    </select>
                                </div>
                                <div class="pt-5 sm:flex sm:flex-row-reverse">
                                    <button type="submit" class="btn btn-primary w-full sm:w-auto sm:ml-3">
                                        Sauvegarder
                                    </button>
                                    <button type="button" class="btn btn-outline w-full sm:w-auto mt-3 sm:mt-0" onclick="document.getElementById('editUserModal').classList.add('hidden')">
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Messages flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="fixed top-4 right-4 z-50">
            <div class="p-4 rounded-md {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'danger' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                {{ message }}
            </div>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<script>
    // Filtrer les utilisateurs
    function filterUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const userItems = document.querySelectorAll('.user-item');
        userItems.forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            const email = item.getAttribute('data-email').toLowerCase();
            if (name.includes(searchTerm) || email.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Ouvrir le modal de modification
    function openEditModal(id, nom, prenom, email, role, statut, telephone, adresse, dateNaissance) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editNom').value = nom;
        document.getElementById('editPrenom').value = prenom;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;
        document.getElementById('editTelephone').value = telephone;
        document.getElementById('editAdresse').value = adresse;
        document.getElementById('editDateNaissance').value = dateNaissance;

        // Afficher/masquer les champs spécifiques aux avocats
        if (role === 'lawyer') {
            document.getElementById('editAvocatFields').style.display = 'block';
        } else {
            document.getElementById('editAvocatFields').style.display = 'none';
        }

        // Configurer l'action du formulaire
        const form = document.getElementById('editUserForm');
        form.action = `/batonnier/utilisateurs/${id}/modifier`;

        // Afficher le modal
        document.getElementById('editUserModal').classList.remove('hidden');
    }

    // Afficher/masquer les champs spécifiques aux avocats dans le modal de création
    document.getElementById('role').addEventListener('change', function() {
        const avocatFields = document.getElementById('avocatFields');
        avocatFields.style.display = this.value === 'lawyer' ? 'block' : 'none';
    });

    // Fermer les modals si on clique en dehors
    document.getElementById('createUserModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });

    document.getElementById('editUserModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
</script>
{% endblock %}

{% extends "layout.html" %}
{% block title %}Gestion des Fonds - Trésorier - Barreau du Niger{% endblock %}
{% block content %}
<style>
  .soft-card { box-shadow: 0 1px 2px rgba(16,24,40,.06), 0 1px 3px rgba(16,24,40,.1); }
  .soft-card:hover { box-shadow: 0 8px 24px rgba(16,24,40,.12); transform: translateY(-1px); }
  .dot { width:.5rem; height:.5rem; border-radius:9999px; display:inline-block; }
  .tab-btn[aria-selected="true"] { background:#fff; color:#0f172a; box-shadow: 0 1px 2px rgba(16,24,40,.06); }
  .modal { position: fixed; inset:0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
  .modal-box { background: white; padding: 1.5rem; border-radius: 0.5rem; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,.2); }
</style>

<div x-data="{
  showValidate: null,
  showCancel: null,
  activeTab: 'fonds'
}" class="max-w-7xl mx-auto px-6 py-8 space-y-8">

  <!-- En-tête -->
  <header class="space-y-1">
    <h1 class="text-3xl font-bold tracking-tight">Gestion des Fonds</h1>
    <p class="text-sm text-slate-500">Système interconnecté de gestion multi-fonds avec workflow de validation</p>
  </header>

  <!-- Cartes des fonds (résumé) -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
    {% for fond in fonds %}
    <article class="soft-card bg-white border border-slate-200 rounded-xl p-4">
      <div class="text-xs text-slate-500">
         <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 font-medium text-slate-700">{{ fond.nom }}</span>
      </div>
      <div class="mt-2 text-2xl font-bold tracking-tight">{{ fond.montant }} FCFA</div>
      <p class="mt-2 text-xs text-slate-500">
        {% if fond.nom == 'Droits de plaidoirie' %}Fonds alimenté par les droits de plaidoirie des avocats
        {% elif fond.nom == 'Solidarité' %}Fonds de solidarité pour aides exceptionnelles
        {% elif fond.nom == 'Externe' %}Fonds provenant de partenaires externes
        {% elif fond.nom == 'Cotisations' %}Fonds provenant des cotisations annuelles
        {% else %}Fonds pour l’assistance juridique et judiciaire
        {% endif %}
      </p>
      <div class="mt-3 flex items-center gap-2 text-xs">
        <span class="dot bg-green-500"></span>
        <span class="text-slate-600">Actif</span>
      </div>
    </article>
    {% endfor %}
  </section>

  <!-- Métriques -->
  <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="soft-card bg-white border border-slate-200 rounded-xl p-5">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs text-slate-500">Total des fonds</div>
          <div class="mt-1 text-2xl font-bold">
            {{ fonds | sum(attribute='montant') }} FCFA
          </div>
          <div class="text-xs text-slate-500 mt-1">{{ fonds | length }} fonds actifs</div>
        </div>
        <div class="h-10 w-10 rounded-lg bg-slate-100 grid place-content-center">
          <i data-lucide="sum" class="h-5 w-5 text-slate-700"></i>
        </div>
      </div>
    </div>
    <div class="soft-card bg-white border border-slate-200 rounded-xl p-5">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs text-slate-500">Opérations en attente</div>
          <div class="mt-1 text-2xl font-bold text-amber-600">{{ operations_en_attente | length }}</div>
          <div class="text-xs text-slate-500 mt-1">Demandes de débit/transferts</div>
        </div>
        <div class="h-10 w-10 rounded-lg bg-amber-50 grid place-content-center">
          <i data-lucide="alert-triangle" class="h-5 w-5 text-amber-700"></i>
        </div>
      </div>
    </div>
  </section>

  <!-- Onglets -->
  <section>
    <div class="inline-flex items-center gap-1 bg-slate-100 rounded-md p-1 mb-4">
      <button @click="activeTab='fonds'" :class="{'tab-btn': true, 'px-3 py-2 rounded text-sm': true, 'aria-selected': activeTab==='fonds'}" aria-selected="true">Fonds</button>
      <button @click="activeTab='operations'" :class="{'tab-btn': true, 'px-3 py-2 rounded text-sm': true, 'aria-selected': activeTab==='operations'}">Opérations en attente</button>
    </div>

    <!-- Contenu des onglets -->
    <div x-show="activeTab==='fonds'" id="tab-fonds">
      {% for fond in fonds %}
      <div class="soft-card bg-white border border-slate-200 rounded-xl px-5 py-4 mb-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold">{{ fond.nom }}</h3>
            <p class="text-sm text-slate-500">
              {% if fond.nom == 'Droits de plaidoirie' %}Fonds alimenté par les droits de plaidoirie
              {% elif fond.nom == 'Solidarité' %}Fonds de solidarité pour aides exceptionnelles
              {% elif fond.nom == 'Externe' %}Fonds provenant de partenaires externes
              {% elif fond.nom == 'Cotisations' %}Fonds provenant des cotisations annuelles
              {% else %}Fonds pour l’assistance juridique
              {% endif %}
            </p>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-xl font-bold">{{ fond.montant }} FCFA</span>
            <span class="inline-flex items-center gap-1 text-xs bg-green-50 text-green-700 px-2.5 py-1 rounded-full border border-green-200">
              <span class="dot bg-green-500"></span> Actif
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Opérations en attente -->
    <div x-show="activeTab==='operations'" id="tab-operations">
      <div class="soft-card bg-white border border-slate-200 rounded-xl p-5">
        <div class="overflow-x-auto">
          <table class="min-w-full border-collapse">
            <thead class="bg-gray-50">
              <tr class="text-left text-sm font-semibold text-gray-600">
                <th class="py-3 px-4">Type</th>
                <th class="py-3 px-4">Montant</th>
                <th class="py-3 px-4"></th>
                <th class="py-3 px-4">Initiateur</th>
                <th class="py-3 px-4">Date</th>
                <th class="py-3 px-4">Actions</th>
              </tr>
            </thead>
            <tbody class="text-sm text-gray-700">
              {% for op in operations_en_attente %}
              <tr class="border-t">
                <td class="py-3 px-4">{{ op.type_operation }}</td>
                <td class="py-3 px-4">{{ op.montant }} FCFA</td>
                <td class="py-3 px-4">{{ op.fond.nom }}</td>
                <td class="py-3 px-4">{{ op.user.nom if op.user else '-' }}</td>
                <td class="py-3 px-4">{{ op.date_creation.strftime('%d/%m/%Y') }}</td>
                <td class="py-3 px-4">
                  <button @click="showValidate={{ op.id }}" class="text-green-600 hover:text-green-900 mr-2">Valider</button>
                  <button @click="showCancel={{ op.id }}" class="text-red-600 hover:text-red-900">Annuler</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Modals -->
  {% for op in operations_en_attente %}
  <!-- Modal Validation -->
  <div x-show="showValidate==={{ op.id }}" class="modal">
    <div class="modal-box">
      <h3 class="text-xl font-semibold mb-4">Valider l'opération #{{ op.id }}</h3>
      <form method="POST" action="{{ url_for('tresorier.valider_operation', operation_id=op.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="valider">
        <p class="mb-4">Confirmez-vous la validation de cette opération ({{ op.type_operation }} - {{ op.montant }} FCFA) ?</p>
        <div class="flex justify-end gap-2">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Oui, valider</button>
          <button type="button" @click="showValidate=null" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Fermer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Annulation -->
  <div x-show="showCancel==={{ op.id }}" class="modal">
    <div class="modal-box">
      <h3 class="text-xl font-semibold mb-4">Annuler l'opération #{{ op.id }}</h3>
      <form method="POST" action="{{ url_for('tresorier.valider_operation', operation_id=op.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="annuler">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Motif d'annulation</label>
          <textarea name="motif_annulation" required class="w-full p-2 border rounded"></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Annuler l'opération</button>
          <button type="button" @click="showCancel=null" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Fermer</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (window.lucide) lucide.createIcons();
  });
</script>
{% endblock %}
